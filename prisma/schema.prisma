// ============================
// GENERATOR & DATASOURCE
// ============================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================
// ENUMS (Core / Agents / Orchestration / Testing)
// ============================

enum Visibility {
  private
  unlisted
  public
}

enum FileType {
  code
  text
  config
  asset
}

enum OAuthProvider {
  github
  google
  line
  custom_oauth
}

enum LoginProvider {
  credentials
  github
  google
  line
  custom_oauth
}

enum DeployProvider {
  vercel
  github_pages
  netlify
}

enum DeployState {
  queued
  building
  ready
  failed
}

enum GenerationChangeType {
  create
  update
  delete
}

enum ChatRole {
  user
  assistant
  system
  tool
}

enum AgentKind {
  chat
  orchestrator
  blueprint
  copywriter
  visual
  editor
  squasher
  tester
  debugger
}

enum CommandStatus {
  queued
  running
  completed
  failed
  cancelled
}

enum TaskStatus {
  pending
  running
  success
  failed
  cancelled
}

enum TestStatus {
  queued
  running
  passed
  failed
  skipped
  errored
}

// ============================
// 2) CORE: User / Project / File / Snapshot / Deployment / Preview
// ============================

model User {
  id            String   @id @default(uuid())
  email         String?  @unique
  displayName   String?
  avatarUrl     String?
  locale        String?  @default("th")
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?

  // Auth
  authCredentials AuthCredential[]
  sessions      Session[]
  oauths        OAuthConnection[]
  loginLogs     LoginAttempt[]
  emailVerifications AuthEmailVerification[]
  passwordResets AuthPasswordReset[]

  // Projects / Collaboration (owner)
  projects      Project[]

  // Chat/Agents layer
  agents        Agent[]
  conversations Conversation[]
  messages      Message[]
  runs          ChatRun[]
  commands      Command[]

  // Generations & likes
  generations   Generation[]
  likes         ProjectLike[]

  @@index([email])
}

model Project {
  id           String     @id @default(uuid())
  ownerId      String
  name         String
  description  String?
  visibility   Visibility @default(private)
  options      Json       @default("{}")
  likeCount    Int        @default(0)

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  deletedAt    DateTime?

  owner        User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  // Files & state
  files        File[]
  snapshots    Snapshot[]
  deployments  Deployment[]
  previews     PreviewSession[]

  // Taxonomy
  categories   ProjectCategory[]
  previewFileId String?   @unique
  previewFile   File?     @relation("ProjectPreviewFile", fields: [previewFileId], references: [id], onDelete: SetNull)

  // AI/Chat
  agents       Agent[]
  conversations Conversation[]
  runs         ChatRun[]

  // Gen history
  generations  Generation[]

  // Orchestration / Spec / Templates / Copy / Visuals / Patches / Tests
  plans        OrchestratorPlan[]
  commands     Command[]
  specBundles  SpecBundle[]
  copyBlocks   CopyBlock[]
  imageBriefs  ImageBrief[]
  imageAssets  ImageAsset[]
  patchSets    PatchSet[]
  testSuites   TestSuite[]
  testRuns     TestRun[]

  // Social
  likes        ProjectLike[]

  @@index([ownerId])
}

model File {
  id        String   @id @default(uuid())
  projectId String
  path      String
  type      FileType @default(code)
  isBinary  Boolean  @default(false)
  content   String?
  blob      Bytes?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // backrefs
  messageAttachments MessageAttachment[]
  previewForProject  Project? @relation("ProjectPreviewFile")
  artifacts          TestArtifact[]
  imageAssets        ImageAsset[]

  @@unique([projectId, path])
  @@index([projectId])
}

model Snapshot {
  id               String   @id @default(uuid())
  projectId        String
  label            String?
  files            Json       // snapshot ของไฟล์ทั้งโปรเจกต์ (hashed/manifest)
  fromGenerationId String?
  createdAt        DateTime @default(now())

  project          Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  fromGeneration   Generation? @relation(fields: [fromGenerationId], references: [id])

  // Patch traversal
  patchSetsFrom    PatchSet[] @relation("PatchSetFrom")
  patchSetsTo      PatchSet[] @relation("PatchSetTo")

  previews         PreviewSession[]

  @@index([projectId])
}

model Deployment {
  id        String        @id @default(uuid())
  projectId String
  provider  DeployProvider
  state     DeployState   @default(queued)
  url       String?
  meta      Json?
  createdAt DateTime      @default(now())

  project   Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model PreviewSession {
  id         String   @id @default(uuid())
  projectId  String
  snapshotId String?
  url        String?
  state      String?  // queued|building|ready|failed
  meta       Json?
  createdAt  DateTime @default(now())

  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  snapshot   Snapshot? @relation(fields: [snapshotId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([snapshotId])
}

// ============================
// 3) AUTH (opaque session + credentials + oauth)
// ============================

model AuthCredential {
  id          String   @id @default(uuid())
  userId      String
  type        String   // password, otp, magic_link, etc.
  identifier  String   // email/phone/username
  secret      String?
  metadata    Json?
  isVerified  Boolean  @default(false)
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  emailVerifs AuthEmailVerification[]
  passwordResets AuthPasswordReset[]

  @@unique([userId, type, identifier])
  @@index([userId])
  @@index([identifier])
}

model AuthEmailVerification {
  id           String   @id @default(uuid())
  userId       String
  credentialId String?
  tokenHash    String
  expiresAt    DateTime
  usedAt       DateTime?
  createdAt    DateTime @default(now())

  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  credential   AuthCredential? @relation(fields: [credentialId], references: [id])

  @@index([userId])
  @@index([expiresAt])
}

model AuthPasswordReset {
  id           String   @id @default(uuid())
  userId       String
  credentialId String?
  tokenHash    String
  expiresAt    DateTime
  usedAt       DateTime?
  createdAt    DateTime @default(now())

  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  credential   AuthCredential? @relation(fields: [credentialId], references: [id])

  @@index([userId])
  @@index([expiresAt])
}

model OAuthConnection {
  id                    String        @id @default(uuid())
  userId                String
  provider              OAuthProvider
  providerAccountId     String
  accessTokenEncrypted  String?
  refreshTokenEncrypted String?
  scope                 String?
  expiresAt             DateTime?
  createdAt             DateTime      @default(now())

  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id               String   @id @default(uuid())
  userId           String
  sessionTokenHash String   @unique
  ip               String?
  userAgent        String?
  createdAt        DateTime @default(now())
  expiresAt        DateTime
  lastActiveAt     DateTime? @default(now())
  terminatedAt     DateTime?

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model LoginAttempt {
  id         String        @id @default(uuid())
  userId     String?
  loginEmail String?
  provider   LoginProvider
  ip         String?
  success    Boolean
  createdAt  DateTime      @default(now())

  user       User?         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

// ============================
// 4) CHAT / AGENTS
// ============================

model Agent {
  id           String    @id @default(uuid())
  projectId    String?
  userId       String?
  name         String
  description  String?
  kind         AgentKind @default(chat)
  model        String
  systemPrompt String?
  tools        Json?
  config       Json?
  temperature  Float?    @default(0.7)
  topP         Float?    @default(1)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  project      Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user         User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  conversations Conversation[]
  runs         ChatRun[]
  sourceCommands Command[]

  @@index([projectId])
  @@index([userId])
}

model Conversation {
  id         String     @id @default(uuid())
  projectId  String?
  userId     String?
  agentId    String?
  title      String?
  visibility Visibility @default(private)
  context    Json?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  archivedAt DateTime?

  project    Project?   @relation(fields: [projectId], references: [id], onDelete: SetNull)
  user       User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  agent      Agent?     @relation(fields: [agentId], references: [id], onDelete: SetNull)
  messages   Message[]
  runs       ChatRun[]
  commands   Command[]

  @@index([projectId])
  @@index([userId])
  @@index([agentId])
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  userId         String?
  role           ChatRole
  content        String?
  contentJson    Json?
  runId          String?
  toolName       String?
  toolInput      Json?
  toolOutput     Json?
  messageIndex   Int
  createdAt      DateTime @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  run            ChatRun?     @relation(fields: [runId], references: [id], onDelete: SetNull)
  attachments    MessageAttachment[]

  @@index([conversationId, messageIndex])
  @@index([userId])
  @@index([runId])
}

model MessageAttachment {
  id        String   @id @default(uuid())
  messageId String
  fileId    String?
  url       String?
  kind      String?
  meta      Json?
  createdAt DateTime @default(now())

  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  file      File?    @relation(fields: [fileId], references: [id], onDelete: SetNull)

  @@index([messageId])
  @@index([fileId])
}

model ChatRun {
  id             String   @id @default(uuid())
  conversationId String
  userId         String?
  projectId      String?
  agentId        String?
  model          String
  tokensInput    Int      @default(0)
  tokensOutput   Int      @default(0)
  costUsd        Decimal  @default(0)
  latencyMs      Int?
  status         String?
  error          String?
  rawRequest     Json?
  rawResponse    Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  agent          Agent?       @relation(fields: [agentId], references: [id], onDelete: SetNull)
  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  project        Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  messages       Message[]

  // relations to other layers
  createdPatchSets PatchSet[]

  @@index([conversationId])
  @@index([agentId])
  @@index([userId])
  @@index([projectId])
}

// ============================
// 5) COMMAND BUS & ORCHESTRATION (DAG)
// ============================

model Command {
  id              String        @id @default(uuid())
  projectId       String?
  userId          String?
  conversationId  String?
  sourceAgentId   String?
  target          String?
  commandType     String
  commandJson     Json
  status          CommandStatus @default(queued)
  error           String?
  createdAt       DateTime      @default(now())
  startedAt       DateTime?
  finishedAt      DateTime?

  project         Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  user            User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  conversation    Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  sourceAgent     Agent?        @relation(fields: [sourceAgentId], references: [id], onDelete: SetNull)
  events          CommandEvent[]
  plans           OrchestratorPlan[]

  @@index([projectId])
  @@index([userId])
  @@index([conversationId])
}

model CommandEvent {
  id         String   @id @default(uuid())
  commandId  String
  kind       String   // queued|started|progress|completed|failed
  data       Json?
  createdAt  DateTime @default(now())

  command    Command  @relation(fields: [commandId], references: [id], onDelete: Cascade)

  @@index([commandId])
}

model OrchestratorPlan {
  id          String   @id @default(uuid())
  projectId   String
  commandId   String?
  title       String?
  decision    Json?
  createdAt   DateTime @default(now())

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  command     Command? @relation(fields: [commandId], references: [id], onDelete: SetNull)
  tasks       OrchestratorTask[]
  edges       OrchestratorEdge[]

  @@index([projectId])
  @@index([commandId])
}

model OrchestratorTask {
  id          String     @id @default(uuid())
  planId      String
  taskKey     String
  to          String
  action      String
  payload     Json?
  status      TaskStatus @default(pending)
  error       String?
  startedAt   DateTime?
  finishedAt  DateTime?
  createdAt   DateTime   @default(now())

  plan        OrchestratorPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@unique([planId, taskKey])
}

model OrchestratorEdge {
  id         String  @id @default(uuid())
  planId     String
  fromTaskId String
  toTaskId   String

  plan       OrchestratorPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
}

// ============================
// 6) SPEC / SSOT
// ============================

model SpecBundle {
  id        String   @id @default(uuid())
  projectId String
  label     String?
  version   Int      @default(1)
  data      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  versions  SpecVersion[]

  @@index([projectId])
}

model SpecVersion {
  id        String   @id @default(uuid())
  bundleId  String
  version   Int
  diff      Json?
  snapshot  Json
  createdAt DateTime @default(now())

  bundle    SpecBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  @@index([bundleId])
  @@unique([bundleId, version])
}

// ============================
// ENUMS
// ============================
enum TemplateStatus {
  draft
  published
  deprecated
}

// ============================
// TEMPLATE CORE
// ============================
model UiTemplate {
  id        String   @id @default(uuid())
  key       String   @unique              // e.g. "restaurant-basic"
  label     String                        // human-friendly name
  category  String?                       // e.g. "restaurant" | "landing" | "portfolio"
  createdAt DateTime @default(now())

  // relations
  versions  UiTemplateVersion[]
  meta      UiTemplateMeta?               // 1:1 meta (normalized)
}

model UiTemplateVersion {
  id          String   @id @default(uuid())
  templateId  String
  version     Int                              // numeric version
  semver      String?                          // optional semantic version (e.g. "1.0.0")
  files       Json?                            // manifest or pointers to objects
  slots       Json?                            // slot schema
  constraints Json?                            // constraints schema
  checksum    String?                          // hash for reproducible builds
  sizeBytes   Int?                             
  status      TemplateStatus @default(published)
  compat      Json?
  publishedAt DateTime?
  deprecatedAt DateTime?
  createdAt   DateTime @default(now())

  template    UiTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, version])
  @@index([templateId])
  @@index([status])
  @@index([createdAt])
}

// ============================
// TEMPLATE META (normalized 1:1)
// ============================
model UiTemplateMeta {
  id                String          @id @default(uuid())
  templateId        String          @unique
  description       String?
  engine            String?         // "nextjs", "astro", ...
  status            TemplateStatus? @default(draft) // publishing lifecycle
  versioningPolicy  String?         // e.g. "immutable-after-publish"
  previewScreenshot String?         // URL to preview image
  compat            Json?           // { breakpoints: [...], node: ">=18", ... }
  postProcess       Json?           // ["mapThemeTokens", "injectSEOHead", ...]
  author            String?         // "midori-core-team"
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // relations
  template          UiTemplate      @relation(fields: [templateId], references: [id], onDelete: Cascade)
  tags              UiTemplateMetaTag[]

  @@index([engine])
  @@index([status])
  @@index([createdAt])
}

// ============================
// TAGS (many-to-many)
// ============================
model Tag {
  id        String   @id @default(uuid())
  key       String   @unique          // slug e.g. "food", "localbiz", "thai-font"
  label     String
  createdAt DateTime @default(now())

  metaLinks UiTemplateMetaTag[]
}

model UiTemplateMetaTag {
  id        String        @id @default(uuid())
  metaId    String
  tagId     String
  createdAt DateTime      @default(now())

  meta      UiTemplateMeta @relation(fields: [metaId], references: [id], onDelete: Cascade)
  tag       Tag            @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([metaId, tagId])
  @@index([metaId])
  @@index([tagId])
}


// ============================
// 8) COPYWRITER (i18n/versions)
// ============================

model CopyBlock {
  id        String   @id @default(uuid())
  projectId String
  key       String
  locale    String   @default("th")
  content   String?
  contentJson Json?
  version   Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@unique([projectId, key, locale, version])
}

// ============================
// 9) VISUAL / ART-DIRECTOR
// ============================

model ImageBrief {
  id             String   @id @default(uuid())
  projectId      String
  sourceMessageId String?
  prompt         String?
  promptJson     Json?
  styleHints     Json?
  createdAt      DateTime @default(now())

  project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assets         ImageAsset[]

  @@index([projectId])
}

model ImageAsset {
  id        String   @id @default(uuid())
  projectId String
  briefId   String?
  fileId    String?
  provider  String?
  meta      Json?
  createdAt DateTime @default(now())

  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  brief     ImageBrief? @relation(fields: [briefId], references: [id], onDelete: SetNull)
  file      File?     @relation(fields: [fileId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([briefId])
  @@index([fileId])
}

// ============================
// 10) PATCH / EDITOR / SQUASHER
// ============================

model PatchSet {
  id             String   @id @default(uuid())
  projectId      String
  fromSnapshotId String?
  toSnapshotId   String?
  createdByRunId String?
  meta           Json?
  createdAt      DateTime @default(now())

  project        Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  fromSnapshot   Snapshot? @relation("PatchSetFrom", fields: [fromSnapshotId], references: [id])
  toSnapshot     Snapshot? @relation("PatchSetTo", fields: [toSnapshotId], references: [id])
  createdByRun   ChatRun?  @relation(fields: [createdByRunId], references: [id], onDelete: SetNull)
  patches        Patch[]

  @@index([projectId])
  @@index([createdByRunId])
}

model Patch {
  id         String   @id @default(uuid())
  patchSetId String
  filePath   String
  changeType GenerationChangeType @default(update)
  hunks      Json?
  createdAt  DateTime @default(now())

  patchSet   PatchSet  @relation(fields: [patchSetId], references: [id], onDelete: Cascade)

  @@index([patchSetId])
  @@index([filePath])
  @@unique([patchSetId, filePath])
}

// ============================
// 11) TESTING
// ============================

model TestSuite {
  id         String   @id @default(uuid())
  projectId  String
  name       String
  kind       String   // unit|e2e|a11y|lint|tsc|schema
  meta       Json?
  createdAt  DateTime @default(now())

  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  cases      TestCase[]
  runs       TestRun[]

  @@index([projectId])
}

model TestCase {
  id         String   @id @default(uuid())
  suiteId    String
  name       String
  definition Json?
  createdAt  DateTime @default(now())

  suite      TestSuite @relation(fields: [suiteId], references: [id], onDelete: Cascade)
  runs       TestRun[]

  @@index([suiteId])
}

model TestRun {
  id               String     @id @default(uuid())
  projectId        String
  suiteId          String?
  caseId           String?
  triggeredByTaskId String?
  status           TestStatus @default(queued)
  stats            Json?
  startedAt        DateTime?
  finishedAt       DateTime?
  createdAt        DateTime   @default(now())

  project          Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  suite            TestSuite? @relation(fields: [suiteId], references: [id], onDelete: SetNull)
  case             TestCase?  @relation(fields: [caseId], references: [id], onDelete: SetNull)
  artifacts        TestArtifact[]

  @@index([projectId])
  @@index([suiteId])
  @@index([caseId])
}

model TestArtifact {
  id        String   @id @default(uuid())
  runId     String
  kind      String   // junit|coverage|screenshots|a11y-report|logs
  url       String?
  fileId    String?
  meta      Json?
  createdAt DateTime @default(now())

  run       TestRun  @relation(fields: [runId], references: [id], onDelete: Cascade)
  file      File?    @relation(fields: [fileId], references: [id], onDelete: SetNull)

  @@index([runId])
  @@index([fileId])
}

// ============================
// 12) GENERATION (ค่าใช้จ่าย/โทเคน/ไฟล์ที่เปลี่ยนจากรัน)
// ============================

model Generation {
  id           String   @id @default(uuid())
  projectId    String
  userId       String
  prompt       Json?
  promptJson   Json?
  options      Json       @default("{}")
  model        String
  tokensInput  Int        @default(0)
  tokensOutput Int        @default(0)
  costUsd      Decimal    @default(0)
  createdAt    DateTime   @default(now())

  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  changes      GenerationFile[]

  snapshots   Snapshot[]

  @@index([projectId])
  @@index([userId])
}

model GenerationFile {
  id           String               @id @default(uuid())
  generationId String
  filePath     String
  fileContent  String?
  changeType   GenerationChangeType @default(create)

  generation   Generation           @relation(fields: [generationId], references: [id], onDelete: Cascade)

  @@index([generationId])
}

// ============================
// 13) TAXONOMY / SOCIAL (ทางเลือก)
// ============================

model Category {
  id        String   @id @default(uuid())
  key       String   @unique
  label     String
  meta      Json?
  createdAt DateTime @default(now())
  projects  ProjectCategory[]
}

model ProjectCategory {
  id         String   @id @default(uuid())
  projectId  String
  categoryId String
  order      Int?
  createdAt  DateTime @default(now())

  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([projectId, categoryId])
  @@index([projectId])
  @@index([categoryId])
}

model ProjectLike {
  id        String   @id @default(uuid())
  projectId String
  userId    String
  createdAt DateTime @default(now())

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}