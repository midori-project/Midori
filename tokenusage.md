# 🪙 Midori Token System - Concept & Flow

> เอกสารอธิบาย Concept และ Flow ของระบบ Token แบบกระชับ เข้าใจง่าย

---

## 🎯 Concept หลัก

### ระบบ Token คืออะไร?
ระบบที่ใช้ **Token** เป็นหน่วยควบคุมการใช้งาน AI Services เพื่อ:
- **จำกัดการใช้งาน** - ป้องกัน abuse และกระจายทรัพยากรอย่างเป็นธรรม
- **Freemium Model** - ให้ฟรี 5 tokens/วัน, ซื้อเพิ่มได้
- **ติดตามการใช้งาน** - บันทึกทุก transaction

---

## 💰 Token Economy

### ราคา Token
```
┌─────────────────────────────────────────┐
│  การใช้งาน              │  Token ที่ใช้     │
├─────────────────────────────────────────┤
│  สร้างเว็บไซต์ใหม่      │  1.5 tokens       │
│  Chat กับ AI            │  0.5 tokens    │
│  สร้าง Preview          │  0 (ฟรี)         │
│  Deploy Website         │  0 (ฟรี)       │
└─────────────────────────────────────────┘
```

### Token Wallet Types
```
┌──────────────────────────────────────────────────────┐
│  STANDARD   │  ผู้ใช้ฟรี - รีเซ็ต 5 tokens ทุกวัน            │
│  PREMIUM    │  ผู้ใช้ที่ซื้อ - ไม่รีเซ็ต                       │
│  BONUS      │  Bonus จากโปรโมชั่น                      │
│  TRIAL      │  Trial tokens (มีวันหมดอายุ)              │
└──────────────────────────────────────────────────────┘
```

---

## 🔄 Token Flows

### Flow 1: User Registration
```
User สมัครสมาชิก
    ↓
สร้าง User Account
    ↓
สร้าง STANDARD Wallet
    ↓
ได้ 5 Tokens ฟรี
    ↓
พร้อมใช้งาน
```

---

### Flow 2: สร้างโปรเจค (Project Creation)
```
┌─────────────────────────────────────────────────────┐
│  1. User คลิก "สร้างเว็บไซต์"                           │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│  2. ตรวจสอบ Token                                   │
│     - ต้องการ: 1.5 tokens                            │
│     - มีอยู่: 5 tokens                                 │
│     - ผลลัพธ์: ✅ พอใช้งานได้                          │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│  3. สร้างโปรเจคในระบบ                                 │
│     - สร้าง Project record                           │
│     - สร้าง Files ในโปรเจค                            │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│  4. หัก Token                                        │
│     - Balance เดิม: 5 tokens                          │
│     - หัก: 1.5 tokens                                │
│     - Balance ใหม่: 3.5 tokens                       │
│     - บันทึก Transaction                             │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│  5. แสดงผล                                          │
│     - โปรเจคสร้างสำเร็จ                                 │
│     - แสดง Token คงเหลือ: 3.5                        │
└─────────────────────────────────────────────────────┘


### Flow 3: Chat กับ AI
```
┌─────────────────────────────────────────────────────┐
│  1. User พิมพ์ข้อความถาม AI                           │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│  2. ตรวจสอบ Token                                   │
│     - ต้องการ: 0.5 tokens                            │
│     - มีอยู่: 3.5 tokens                               │
│     - ผลลัพธ์: ✅ พอใช้งานได้                          │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│  3. ประมวลผล Chat ด้วย AI                            │
│     - วิเคราะห์คำถาม                                   │
│     - สร้างคำตอบ                                     │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│  4. หัก Token                                        │
│     - Balance เดิม: 3.5 tokens                       │
│     - หัก: 0.5 tokens                                │
│     - Balance ใหม่: 3 tokens                         │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│  5. แสดงคำตอบ + Token คงเหลือ                       │
└─────────────────────────────────────────────────────┘
```

---

### Flow 4: Daily Reset (รีเซ็ตทุกวัน)
```
┌─────────────────────────────────────────────────────┐
│  เวลา 00:00 น. ทุกวัน (Cron Job)                      │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│  1. ค้นหา STANDARD Wallets ที่ต้องรีเซ็ต                  │
│     - lastTokenReset < วันนี้                          │
│     - isActive = true                               │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│  2. รีเซ็ต Token ทีละ Wallet                           │
│     - ตั้ง balanceTokens = 5                          │
│     - อัปเดต lastTokenReset = ปัจจุบัน                  │
│     - บันทึก Transaction (DAILY_RESET)                │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│  3. ล้าง Memory Cache                                |
│     - ล้าง cache ทั้งหมด                               │
│     - User จะได้ข้อมูล fresh เมื่อเข้าใช้                   │
└─────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────┐
│  4. บันทึก Log                                        │
│     - จำนวน Wallets ที่รีเซ็ต                           │
│     - เวลาที่ทำงาน                                    │
└─────────────────────────────────────────────────────┘
```

## 🧠 ระบบ Memory Cache

### Concept
แทนที่จะ query database ทุกครั้ง → เก็บข้อมูล token ใน memory (RAM)

### ประโยชน์
```
┌───────────────────────────────────────────┐
│  ไม่ใช้ Cache          │  ใช้ Cache          │
├───────────────────────────────────────────┤
│  Query DB: 100ms      │  Read RAM: 1ms    │
│  Database load สูง     │  Database load ต่ำ │
│  Slow                 │  Fast ⚡          │
└───────────────────────────────────────────┘
```

### Cache Flow
```
Request 1: ไม่มี cache → Query DB → เก็บใน cache
Request 2: มี cache → อ่านจาก cache (เร็ว!)
Request 3: มี cache → อ่านจาก cache (เร็ว!)
...
หลัง 30 นาที: cache หมดอายุ → ลบออก
Request ใหม่: Query DB อีกครั้ง → เก็บ cache ใหม่
```

---

## 🎨 User Experience Flow

### สถานการณ์ที่ 1: User ใหม่
```
Day 1 (10:00 น.)
├─ สมัครสมาชิก
├─ ได้ 5 tokens
├─ สร้างเว็บไซต์ 3 เว็บ → ใช้ 4.5 tokens
└─ คงเหลือ: 0.5 tokens

Day 2 (00:00 น.)
├─ ระบบรีเซ็ต → ได้ 5 tokens ใหม่
└─ สร้างเว็บไซต์ต่อได้อีก
```

### สถานการณ์ที่ 2: User ใช้หมด
```
Token คงเหลือ: 0.5 tokens
User พยายามสร้างเว็บไซต์ใหม่ (ต้องการ 1.5 tokens)
    ↓
❌ แจ้งเตือน: "Token ไม่เพียงพอ"
    ↓
แนะนำ:
  ✅ รอรีเซ็ตวันพรุ่งนี้ (00:00 น.)
  ✅ Chat ได้อีก 1 ครั้ง (ใช้แค่ 0.5 tokens)
  ⏳ ซื้อ Token เพิ่ม (Coming Soon)
```

### สถานการณ์ที่ 3: User ซื้อ Token
```
มี STANDARD wallet: 0.5 tokens (จะรีเซ็ตทุกวัน)
ซื้อ Pro Pack: 55 tokens
    ↓
ได้ PREMIUM wallet: 55 tokens (ไม่รีเซ็ต)
    ↓
รวม: 55.5 tokens
    ↓
เมื่อใช้งาน:
  1. หักจาก STANDARD ก่อน (0.5 tokens)
  2. หักจาก PREMIUM (55 tokens)
```

---

## 📊 Token Wallet Priority

### ลำดับการหัก Token
```
┌─────────────────────────────────────────┐
│  Priority 1: STANDARD (ฟรี)              │
│  Priority 2: PREMIUM (ซื้อ)               │
│  Priority 3: BONUS (โปรโมชั่น)            │
│  Priority 4: TRIAL (ทดลอง)              │
└─────────────────────────────────────────┘
```

### ตัวอย่าง
```
User มี:
  - STANDARD: 2 tokens
  - PREMIUM: 50 tokens
  - BONUS: 10 tokens

สร้างเว็บไซต์ (1.5 tokens):
  ✅ หักจาก STANDARD: 1.5 tokens
  ❌ ไม่แตะ PREMIUM และ BONUS

STANDARD เหลือ 0.5 tokens

สร้างเว็บไซต์อีกครั้ง (1.5 tokens):
  ✅ หักจาก STANDARD: 0.5 tokens (หมด)
  ✅ หักจาก PREMIUM: 1 token
  ❌ ไม่แตะ BONUS
```

---

## 🔐 Transaction Logging

### ทุกการเปลี่ยนแปลงถูกบันทึก
```
┌────────────────────────────────────────────────┐
│  Transaction Record                            │
├────────────────────────────────────────────────┤
│  • userId: ใคร                                 │
│  • amount: เท่าไหร่ (+เพิ่ม / -หัก)                 │
│  • type: ทำอะไร (PROJECT_CREATION, etc.)       │
│  • timestamp: เมื่อไหร่                           │
│  • metadata: ข้อมูลเพิ่มเติม                        │
└────────────────────────────────────────────────┘
```


## 🎯 สรุป Concept หลัก

### 3 หลักการสำคัญ

**1. Fair Use (ใช้งานอย่างเป็นธรรม)**
```
ผู้ใช้ฟรี: 5 tokens/วัน
เพียงพอสำหรับ:
  - สร้างเว็บไซต์ 3 เว็บ
  - หรือ Chat 10 ครั้ง
  - หรือผสมกัน
```

**2. Transparent (โปร่งใส)**
```
User เห็น:
  ✅ Token คงเหลือชัดเจน
  ✅ แต่ละการใช้งานใช้เท่าไหร่
  ✅ ประวัติการใช้งานทั้งหมด
```

**3. Flexible (ยืดหยุ่น)**
```
- ฟรี: 5 tokens/วัน
- ซื้อเพิ่ม: แพคเกจหลากหลาย
- Bonus: จากโปรโมชั่น
- Trial: ทดลองใช้ฟีเจอร์ใหม่
```

---

## 🚀 Key Takeaways

1. **Token = หน่วยควบคุมการใช้งาน AI**
2. **ฟรี 5 tokens/วัน (รีเซ็ตทุก 00:00 น.)**
3. **สร้างเว็บ = 1.5 tokens, Chat = 0.5 tokens**
4. **ใช้ Memory Cache เพื่อความเร็ว**
5. **บันทึก Transaction ทุกครั้ง**
6. **สามารถซื้อเพิ่มได้ (อนาคต)**


