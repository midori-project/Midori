# Export Format Fix - Complete Summary

## ปัญหาที่พบ

ระบบ Component Base สร้างโครงสร้างไฟล์ออกมา**ไม่ตรงกับ format มาตรฐาน** (`test-cafe-complete.json`):

### ❌ Format ที่ผิด (ก่อนแก้):
```json
{
  "exportedJson": {              // ← wrapper ที่ไม่ควรมี
    "files": [...],
    "projectStructure": {...}
  },
  "blocksGenerated": [...],      // ← fields พิเศษที่ไม่ควรอยู่
  "businessCategory": "...",
  "aiContentGenerated": true,
  "exportFormatVersion": "v1"
}
```

### ✅ Format ที่ถูกต้อง (ตาม test-cafe-complete.json):
```json
{
  "projectStructure": {
    "name": "food-delivery-table-reservation",
    "type": "vite-react-typescript",
    "description": "Food delivery app..."
  },
  "files": [
    {
      "path": "package.json",
      "content": "...",
      "type": "config",
      "language": "json"
    }
  ]
}
```

---

## สาเหตุของปัญหา

### 1. Database Storage (Snapshot.templateData)
```typescript
// ใน persistence-service.ts
templateData: {
  businessCategory: "...",
  blocksGenerated: [...],
  aiContentGenerated: true,
  projectStructure: {...},
  exportedJson: {              // ← ถูกต้อง แต่อยู่ภายใน templateData
    projectStructure: {...},
    files: [...]
  },
  exportFormatVersion: "v1"
}
```

### 2. API Response ส่งผิด
```typescript
// ใน /api/projects/[id]/snapshot/route.ts
return NextResponse.json({
  data: {
    templateData: templateData || {},  // ← ส่งทั้งก้อน (ผิด!)
    files: [...]
  }
})
```

---

## การแก้ไข

### ✅ Fix 1: `persistence-service.ts` - buildExportedJson()

**File:** `src/midori/agents/frontend-v2/services/persistence-service.ts`

```typescript
/**
 * Build exported JSON compatible with test-cafe-complete.json format
 * Format: { projectStructure, files }
 */
function buildExportedJson(result: ComponentResultV2, filesToPersist: Array<any>) {
  const projectStructure = (result as any).projectStructure?.projectStructure || {
    name: result.metadata?.projectName || 'project',
    type: (result as any).projectStructure?.type || 'vite-react-typescript',
    description: result.result?.description || 'Generated by frontend-v2',
  };

  const mapLanguage = (file: any): string | undefined => {
    const p: string = file.path || '';
    if (p.endsWith('.tsx')) return 'typescript';
    if (p.endsWith('.ts')) return 'typescript';
    if (p.endsWith('.js')) return 'javascript';
    if (p.endsWith('.cjs')) return 'javascript';
    if (p.endsWith('.jsx')) return 'javascript';
    if (p.endsWith('.css')) return 'css';
    if (p.endsWith('.html')) return 'html';
    if (p.endsWith('.json')) return 'json';
    if (p.endsWith('.md')) return 'markdown';
    return undefined;
  };

  const mapType = (file: any): string => {
    const p: string = file.path || '';
    // Force specific mappings
    if (p === 'package.json') return 'config';
    if (p === 'tsconfig.json') return 'config';
    if (p === 'index.html') return 'config';
    if (p === 'vite.config.ts') return 'config';
    if (p === 'tailwind.config.js') return 'config';
    if (p === 'postcss.config.cjs') return 'config';
    if (p === 'src/main.tsx') return 'page';
    if (p === 'src/App.tsx') return 'page';
    if (p.startsWith('src/pages/')) return 'page';
    if (p.startsWith('src/components/')) return 'component';
    if (p.endsWith('.css')) return 'style';
    if (p.endsWith('.html')) return 'config';
    if (p.endsWith('.json')) return 'config';
    return 'component';
  };

  const files = filesToPersist.map((f: any) => ({
    path: f.path,
    content: typeof f.content === 'string' ? f.content : JSON.stringify(f.content, null, 2),
    type: mapType(f),
    language: mapLanguage(f),
  }));

  // ✅ Return format matching test-cafe-complete.json (no wrapper)
  return { 
    projectStructure, 
    files 
  };
}
```

**Key Changes:**
- ✅ ไม่มี wrapper `exportedJson`
- ✅ Return แค่ `{ projectStructure, files }`
- ✅ เพิ่ม file type mapping ที่ละเอียด
- ✅ Handle content ที่เป็น object

---

### ✅ Fix 2: API Route - `/api/projects/[id]/snapshot`

**File:** `src/app/api/projects/[id]/snapshot/route.ts`

**Before:**
```typescript
return NextResponse.json({
  data: {
    snapshot: {...},
    project: {...},
    templateData: templateData || {},  // ❌ ส่งทั้งก้อน
    files: formattedFiles
  }
})
```

**After:**
```typescript
// ✅ ส่งเฉพาะ exportedJson ที่มี format ถูกต้อง
const exportedJson = templateData?.exportedJson || {
  projectStructure: {
    name: project.name || 'project',
    type: 'vite-react-typescript',
    description: project.description || 'Generated project'
  },
  files: formattedFiles
}

return NextResponse.json({
  data: {
    snapshot: {...},
    project: {...},
    // ✅ Spread exportedJson ออกมา
    ...exportedJson,
    filesCount: formattedFiles.length,
    _templateData: templateData || {},  // backward compatibility
  }
})
```

**Key Changes:**
- ✅ Extract `exportedJson` from `templateData`
- ✅ Spread `exportedJson` ออกมาที่ root level ของ `data`
- ✅ ผลลัพธ์: `{ projectStructure, files, ... }`
- ✅ เก็บ `_templateData` ไว้สำหรับ backward compatibility

---

## ผลลัพธ์

### ✅ API Response Format (ถูกต้องแล้ว)

```json
{
  "success": true,
  "hasSnapshot": true,
  "message": "ดึงข้อมูลสำเร็จ",
  "data": {
    "snapshot": {
      "id": "...",
      "label": "...",
      "createdAt": "..."
    },
    "project": {
      "id": "...",
      "name": "...",
      "description": "..."
    },
    "projectStructure": {           // ✅ ถูกต้อง
      "name": "food-delivery-app",
      "type": "vite-react-typescript",
      "description": "Restaurant app..."
    },
    "files": [                      // ✅ ถูกต้อง
      {
        "path": "package.json",
        "content": "{...}",
        "type": "config",
        "language": "json"
      },
      {
        "path": "src/App.tsx",
        "content": "import React...",
        "type": "page",
        "language": "typescript"
      }
    ],
    "filesCount": 15,
    "_templateData": {              // ✅ สำหรับ backward compatibility
      "businessCategory": "restaurant",
      "blocksGenerated": [...],
      "exportedJson": {...}
    }
  }
}
```

### ✅ Database Storage (ไม่ต้องเปลี่ยน)

```typescript
Snapshot.templateData = {
  businessCategory: "restaurant",
  blocksGenerated: [...],
  aiContentGenerated: true,
  projectStructure: {...},
  exportedJson: {              // ✅ ถูกต้องอยู่แล้ว
    projectStructure: {...},
    files: [...]
  },
  exportFormatVersion: "v1"
}
```

---

## การทดสอบ

### Test Script
```bash
# Run export format test
npx tsx src/midori/agents/frontend-v2/tests/test-export-format.ts
```

### Expected Output
```
=== Export Format Test ===
✓ Has projectStructure at root level: true
✓ Has files at root level: true
✓ No exportedJson wrapper: true
✓ Matches test-cafe-complete.json format: true
```

### Manual Test
```bash
# 1. Generate new project
curl -X POST http://localhost:3000/api/projects/generate

# 2. Get snapshot
curl http://localhost:3000/api/projects/{id}/snapshot

# 3. Verify response format
```

---

## Migration Guide

### สำหรับ Frontend/API Consumers

**Before (ผิด):**
```typescript
const response = await fetch('/api/projects/123/snapshot')
const data = await response.json()

// ผิด - ต้อง access ผ่าน templateData.exportedJson
const project = data.data.templateData.exportedJson
const files = project.files
```

**After (ถูกต้อง):**
```typescript
const response = await fetch('/api/projects/123/snapshot')
const data = await response.json()

// ถูก - ใช้ได้เลย
const projectStructure = data.data.projectStructure
const files = data.data.files
```

### สำหรับการ Export ไฟล์

**Before (ผิด):**
```typescript
// ไฟล์ที่ export ออกมามี wrapper
{
  "exportedJson": {
    "projectStructure": {...},
    "files": [...]
  }
}
```

**After (ถูกต้อง):**
```typescript
// ไฟล์ที่ export ออกมาแบน
{
  "projectStructure": {...},
  "files": [...]
}
```

---

## Files Modified

### ✅ Core Changes
1. `src/midori/agents/frontend-v2/services/persistence-service.ts` - buildExportedJson()
2. `src/app/api/projects/[id]/snapshot/route.ts` - API response format

### ✅ Test Files
3. `src/midori/agents/frontend-v2/tests/test-export-format.ts` - Validation test
4. `src/components/preview/test/exportedJson.json` - Reference file (updated manually)

### ✅ Documentation
5. `docs/component-system-export-format.md` - Complete documentation
6. `docs/export-format-fix-summary.md` - This file
7. `src/midori/agents/frontend-v2/docs/export-format-update.md` - Technical details

---

## Validation Checklist

- [x] `buildExportedJson()` returns correct format
- [x] No `exportedJson` wrapper
- [x] API response has `projectStructure` at root
- [x] API response has `files` at root
- [x] Test script passes
- [x] Format matches `test-cafe-complete.json`
- [x] Backward compatibility maintained via `_templateData`

---

## Next Steps

1. ✅ **แก้ไขเสร็จสิ้น** - Format ถูกต้องแล้ว
2. ⏳ **รันระบบใหม่** - เพื่อสร้าง export ที่ถูกต้อง
3. ⏳ **ทดสอบ Integration** - ตรวจสอบกับ preview system
4. ⏳ **Update Frontend** - ใช้ format ใหม่

---

**Date:** 2025-10-10  
**Status:** ✅ Fixed  
**Version:** v1.0.0  
**Impact:** All new exports will use correct format

