{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "plan.schema.json", 
  "title": "Midori Execution Plan Schema",
  "description": "Schema for execution plans generated by Orchestrator",
  "type": "object",
  "required": ["planId", "commandId", "tasks", "executionGraph", "estimatedTotalDuration"],
  "properties": {
    "planId": {
      "type": "string",
      "description": "Unique identifier for the execution plan",
      "pattern": "^plan-[a-zA-Z0-9-]+$"
    },
    "commandId": {
      "type": "string", 
      "description": "ID of the originating command",
      "pattern": "^cmd-[a-zA-Z0-9-]+$"
    },
    "tasks": {
      "type": "array",
      "description": "List of tasks to be executed",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/Task"
      }
    },
    "executionGraph": {
      "type": "object",
      "description": "Directed Acyclic Graph (DAG) for task execution",
      "required": ["parallel", "sequential"],
      "properties": {
        "parallel": {
          "type": "array",
          "description": "Groups of tasks that can run in parallel",
          "items": {
            "type": "array",
            "items": {
              "type": "string",
              "description": "Task ID"
            }
          }
        },
        "sequential": {
          "type": "array",
          "description": "Tasks that must run sequentially",
          "items": {
            "type": "string",
            "description": "Task ID"
          }
        }
      }
    },
    "qualityGates": {
      "type": "array",
      "description": "Quality gates that must be passed",
      "items": {
        "$ref": "#/definitions/QualityGate"
      }
    },
    "rollbackPlan": {
      "type": "object",
      "description": "Plan for rolling back changes if needed",
      "properties": {
        "steps": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Ordered list of rollback steps"
        },
        "triggers": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["test_failure", "security_violation", "performance_degradation", "manual", "timeout"]
          },
          "description": "Conditions that trigger rollback"
        },
        "estimatedDuration": {
          "type": "integer",
          "description": "Estimated rollback duration in minutes",
          "minimum": 1
        }
      }
    },
    "estimatedTotalDuration": {
      "type": "integer",
      "description": "Total estimated execution time in minutes",
      "minimum": 1
    },
    "resourceRequirements": {
      "type": "object",
      "description": "Resource requirements for plan execution",
      "properties": {
        "maxParallelTasks": {
          "type": "integer",
          "description": "Maximum tasks that can run in parallel",
          "minimum": 1,
          "maximum": 10
        },
        "totalCpuUnits": {
          "type": "integer",
          "description": "Total CPU units required",
          "minimum": 1
        },
        "totalMemoryUnits": {
          "type": "integer", 
          "description": "Total memory units required",
          "minimum": 1
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Plan metadata and creation info",
      "properties": {
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "When the plan was created"
        },
        "createdBy": {
          "type": "string",
          "description": "Orchestrator version that created the plan"
        },
        "complexity": {
          "type": "string",
          "enum": ["simple", "medium", "complex"],
          "description": "Plan complexity level"
        },
        "agentsInvolved": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["frontend", "backend", "devops"]
          },
          "description": "Agents involved in execution"
        }
      }
    }
  },
  "definitions": {
    "Task": {
      "type": "object",
      "required": ["taskId", "agent", "action", "description", "dependencies", "estimatedDuration", "priority"],
      "properties": {
        "taskId": {
          "type": "string",
          "description": "Unique identifier for the task",
          "pattern": "^[a-zA-Z0-9-]+$"
        },
        "agent": {
          "type": "string",
          "description": "Agent responsible for executing the task", 
          "enum": ["frontend", "backend", "devops"]
        },
        "action": {
          "type": "string",
          "description": "Specific action to be performed",
          "examples": [
            "create_component",
            "update_component", 
            "create_api_endpoint",
            "update_database_schema",
            "deploy_application"
          ]
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of the task",
          "minLength": 5,
          "maxLength": 200
        },
        "dependencies": {
          "type": "array",
          "description": "Task IDs that must complete before this task",
          "items": {
            "type": "string"
          }
        },
        "estimatedDuration": {
          "type": "integer",
          "description": "Estimated duration in minutes",
          "minimum": 1,
          "maximum": 480
        },
        "priority": {
          "type": "string",
          "description": "Task execution priority",
          "enum": ["low", "medium", "high", "critical"]
        },
        "resources": {
          "type": "object",
          "description": "Resource requirements for the task",
          "properties": {
            "cpu": {
              "type": "string",
              "enum": ["low", "medium", "high"],
              "description": "CPU requirement level"
            },
            "memory": {
              "type": "string", 
              "enum": ["low", "medium", "high"],
              "description": "Memory requirement level"
            },
            "storage": {
              "type": "string",
              "enum": ["low", "medium", "high"],
              "description": "Storage requirement level"
            }
          }
        },
        "payload": {
          "type": "object",
          "description": "Task-specific data and parameters",
          "additionalProperties": true
        },
        "timeout": {
          "type": "integer",
          "description": "Maximum execution time in minutes before timeout",
          "minimum": 1,
          "maximum": 240
        },
        "retryPolicy": {
          "type": "object",
          "description": "Retry policy for failed tasks",
          "properties": {
            "maxRetries": {
              "type": "integer",
              "minimum": 0,
              "maximum": 5,
              "default": 2
            },
            "backoffStrategy": {
              "type": "string",
              "enum": ["linear", "exponential"],
              "default": "exponential"
            }
          }
        }
      }
    },
    "QualityGate": {
      "type": "object",
      "required": ["gate", "required", "trigger"],
      "properties": {
        "gate": {
          "type": "string",
          "description": "Name of the quality gate",
          "enum": [
            "security_scan",
            "performance_check", 
            "schema_validation",
            "code_review",
            "unit_tests",
            "integration_tests",
            "accessibility_check",
            "dependency_audit"
          ]
        },
        "required": {
          "type": "boolean",
          "description": "Whether this gate must pass to continue"
        },
        "trigger": {
          "type": "string", 
          "description": "When the gate should be executed",
          "enum": ["before_start", "before_deploy", "after_completion", "on_failure"]
        },
        "configuration": {
          "type": "object",
          "description": "Gate-specific configuration",
          "additionalProperties": true
        }
      }
    }
  },
  "examples": [
    {
      "planId": "plan-create-auth-system-001",
      "commandId": "cmd-create-auth-system-001", 
      "tasks": [
        {
          "taskId": "be-auth-api-001",
          "agent": "backend",
          "action": "create_api_endpoint",
          "description": "Create authentication API endpoints",
          "dependencies": [],
          "estimatedDuration": 60,
          "priority": "high",
          "resources": {
            "cpu": "medium",
            "memory": "medium"
          },
          "payload": {
            "endpoints": ["/auth/login", "/auth/register", "/auth/refresh"],
            "authentication": "jwt",
            "validation": "zod"
          }
        },
        {
          "taskId": "fe-login-form-001",
          "agent": "frontend", 
          "action": "create_component",
          "description": "Create login form component",
          "dependencies": ["be-auth-api-001"],
          "estimatedDuration": 45,
          "priority": "high",
          "resources": {
            "cpu": "medium",
            "memory": "low"
          },
          "payload": {
            "componentName": "LoginForm",
            "features": ["validation", "accessibility"],
            "styling": "tailwind"
          }
        }
      ],
      "executionGraph": {
        "parallel": [["be-auth-api-001"]],
        "sequential": ["fe-login-form-001"]
      },
      "qualityGates": [
        {
          "gate": "security_scan",
          "required": true,
          "trigger": "before_deploy"
        },
        {
          "gate": "unit_tests",
          "required": true,
          "trigger": "after_completion"
        }
      ],
      "estimatedTotalDuration": 105,
      "resourceRequirements": {
        "maxParallelTasks": 2,
        "totalCpuUnits": 4,
        "totalMemoryUnits": 3
      }
    }
  ]
}