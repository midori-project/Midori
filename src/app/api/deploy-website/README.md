# Deployment API Documentation

## Overview
This API handles automatic deployment of websites generated by Midori's AI agents to Vercel with subdomain assignment.

## Endpoints

### POST /api/deploy-website
Deploy a website to Vercel with automatic subdomain assignment.

**Request Body:**
```typescript
{
  projectId: string;           // UUID of the project
  files: Array<{               // Files to deploy
    path: string;              // File path (e.g., "pages/index.js")
    content: string;            // File content
    type: 'code' | 'text' | 'asset';
  }>;
  subdomain?: string;           // Optional custom subdomain
  buildCommand?: string;        // Default: "npm run build"
  outputDirectory?: string;     // Default: ".next"
  environmentVariables?: Record<string, string>;
}
```

**Response:**
```typescript
{
  success: boolean;
  data?: {
    deploymentId: string;
    projectId: string;
    url?: string;
    state: 'queued' | 'building' | 'ready' | 'failed';
    vercelDeploymentId?: string;
    createdAt: string;
  };
  error?: string;
}
```

### GET /api/deploy-website
Get deployment status.

**Query Parameters:**
- `deploymentId` (optional): Specific deployment ID
- `projectId` (optional): Project ID to get latest deployment

**Response:**
```typescript
{
  success: boolean;
  data?: {
    deploymentId: string;
    projectId: string;
    url?: string;
    state: 'queued' | 'building' | 'ready' | 'failed';
    provider: 'vercel';
    createdAt: string;
    project: {
      id: string;
      name: string;
      owner: {
        id: string;
        displayName: string;
      };
    };
  };
  error?: string;
}
```

## Environment Variables Required

```bash
VERCEL_TOKEN=your_vercel_token
VERCEL_TEAM_ID=your_team_id  # Optional
```

## Integration with Orchestrator

The deployment API is integrated with the orchestrator agent system:

1. **Orchestrator** creates deployment tasks
2. **DevOps Agent** handles the deployment via `deployment_dispatcher.ts`
3. **Database** tracks deployment status in `Deployment` model
4. **Vercel API** performs the actual deployment

## Usage Example

```typescript
// Create deployment task
const deploymentTask = createDeploymentTask(
  'project-uuid',
  [
    { path: 'pages/index.js', content: 'export default function Home() { return <div>Hello World</div> }', type: 'code' },
    { path: 'package.json', content: '{"name": "my-app", "scripts": {"build": "next build"}}', type: 'text' }
  ],
  {
    subdomain: 'my-awesome-site',
    buildCommand: 'npm run build',
    outputDirectory: '.next'
  }
);

// Dispatch via orchestrator
const result = await dispatchDeploymentTask(deploymentTask);
```

## Error Handling

The API follows the established patterns:
- Zod validation for request/response schemas
- Standardized error responses
- Proper HTTP status codes
- Database transaction safety

## Database Schema

Uses existing `Deployment` model in Prisma schema:
- `id`: UUID
- `projectId`: Foreign key to Project
- `provider`: 'vercel' | 'github_pages' | 'netlify'
- `state`: 'queued' | 'building' | 'ready' | 'failed'
- `url`: Deployment URL
- `meta`: JSON metadata (Vercel response, files, etc.)
